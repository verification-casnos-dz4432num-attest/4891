<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vérification Sécurisée</title>
    <style>
        body { 
            margin: 0; 
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        .info {
            border: 1px solid #4CAF50;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        #debug-console {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            margin-top: 20px;
            white-space: pre-wrap;
        }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <div id="app">
        <h1 style="color: #4CAF50; text-align: center;">Vérification d'attestation</h1>
        
        <div class="info">
            <p><strong>Matricule :</strong> <span id="matricule">-</span></p>
            <p><strong>N° attestation :</strong> <span id="num_attest">-</span></p>
            <p><strong>Nom :</strong> <span id="nom">-</span></p>
            <p><strong>Prénom :</strong> <span id="prenom">-</span></p>
            <p><strong>Date de naissance :</strong> <span id="date_naissance">-</span></p>
            <p><strong>Date mise à jour :</strong> <span id="date_maj">-</span></p>
            <p><strong>Date d'annulation :</strong> <span id="date_annulation" class="error">-</span></p>
        </div>

        <div id="debug-console">[SYSTÈME] Initialisation en cours...</div>
    </div>

    <!-- Librairies Firebase et CryptoJS -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA4fkmfRxjuNEXWbOMOlBsIq2N6lZnd4ps",
            authDomain: "verif-clients-f5915.firebaseapp.com",
            databaseURL: "https://verif-clients-f5915-default-rtdb.firebaseio.com",
            projectId: "verif-clients-f5915",
            storageBucket: "verif-clients-f5915.appspot.com",
            messagingSenderId: "914666601909",
            appId: "1:914666601909:web:286ad5057da0ac0ea46dfc"
        };

        // Initialisation
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const debug = document.getElementById('debug-console');

        // Fonction de logging améliorée
        function log(message, type = 'info') {
            const prefix = `[${new Date().toLocaleTimeString()}]`;
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            debug.innerHTML += `<div style="color:${color}">${prefix} ${message}</div>`;
            console[type === 'error' ? 'error' : 'log'](message);
        }

        // Processus principal
        async function initApp() {
            try {
                log("Connexion anonyme à Firebase...");
                await auth.signInAnonymously();
                log(`✅ Connecté (UID: ${auth.currentUser.uid.substring(0, 8)}...)`, 'success');

                log("Analyse de l'URL...");
                const params = new URLSearchParams(window.location.search);
                const encryptedData = params.get('data');
                const matricule = params.get('matricule');

                if (!encryptedData || !matricule) {
                    throw new Error("Paramètres manquants dans l'URL (data et matricule requis)");
                }

                log("Vérification blacklist...");
                const blacklistSnapshot = await db.ref('blacklist/' + matricule).once('value');
                if (blacklistSnapshot.exists()) {
                    throw new Error(`Matricule ${matricule} est blacklisté`);
                }

                log("Récupération de la clé AES...");
                const keySnapshot = await db.ref('config/cleAES').once('value');
                const cleAES = keySnapshot.val();

                log("Déchiffrement des données...");
                const bytes = CryptoJS.AES.decrypt(encryptedData, cleAES);
                const decrypted = bytes.toString(CryptoJS.enc.Utf8);
                
                if (!decrypted) {
                    throw new Error("Échec du déchiffrement (clé ou données invalides)");
                }

                log(`✅ Données décryptées: ${decrypted}`, 'success');
                displayData(decrypted.split('|'));

            } catch (error) {
                log(`❌ ERREUR: ${error.message}`, 'error');
                document.getElementById('debug-console').classList.add('error');
            }
        }

        // Affichage des données
        function displayData(data) {
            const fields = [
                'matricule', 'num_attest', 'nom', 'prenom', 
                'date_naissance', 'date_maj', 'date_annulation'
            ];
            
            fields.forEach((field, index) => {
                const element = document.getElementById(field);
                if (element) {
                    element.textContent = data[index] || 'Non fourni';
                    if (field === 'date_annulation' && data[index]) {
                        element.classList.add('error');
                    }
                }
            });
        }

        // Lancement de l'application
        initApp();
    </script>
</body>
</html>
